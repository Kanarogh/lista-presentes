<!DOCTYPE html>
<html lang="pt-BR">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Lista de Presentes - ChÃ¡ de Casa Nova</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body {
      box-sizing: border-box;
      font-family: ui-sans-serif, system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol", "Noto Color Emoji";
    }

    .gradient-bg {
      background: linear-gradient(135deg, #f8fffe 0%, #f0fdf4 100%);
    }

    .gold-accent {
      background: linear-gradient(135deg, #fbbf24, #f59e0b);
    }

    .item-card {
      background-color: white;
      border: 1px solid #e5e7eb;
      border-radius: 1rem;
      padding: 1.5rem;
      transition: all 0.3s ease;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      position: relative;
      /* MUITO IMPORTANTE: Para posicionar os controles de admin */
    }

    .item-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.08);
    }

    /* NOVO: Estilos para o painel de controles do admin */
    .admin-controls {
      position: absolute;
      top: 0.75rem;
      right: 0.75rem;
      display: flex;
      gap: 0.5rem;
      background-color: rgba(255, 255, 255, 0.8);
      backdrop-filter: blur(4px);
      border-radius: 9999px;
      padding: 0.25rem;
      opacity: 0;
      /* ComeÃ§a invisÃ­vel */
      transition: opacity 0.2s ease-in-out;
    }

    /* NOVO: LÃ³gica para mostrar os controles no hover (apenas para admin) */
    .item-card:hover .admin-controls {
      opacity: 1;
    }

    .admin-btn {
      background-color: #f3f4f6;
      border-radius: 50%;
      padding: 0.5rem;
      line-height: 1;
      transition: background-color 0.2s;
    }

    .admin-btn:hover {
      background-color: #e5e7eb;
    }

    .category-tag {
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      background-color: #ecfdf5;
      color: #065f46;
      padding: 0.25rem 0.75rem;
      border-radius: 9999px;
      font-size: 0.8rem;
      font-weight: 500;
    }

    .primary-button {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
      width: 100%;
      background-color: #22c55e;
      color: white;
      font-weight: 600;
      padding: 0.75rem 1rem;
      border-radius: 0.5rem;
      transition: all 0.2s ease;
    }

    .primary-button:hover {
      background-color: #16a34a;
      transform: scale(1.03);
    }

    .secondary-button {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
      width: 100%;
      background-color: transparent;
      color: #4b5563;
      font-weight: 500;
      padding: 0.75rem 1rem;
      border-radius: 0.5rem;
      border: 1px solid #d1d5db;
      transition: all 0.2s ease;
    }

    .secondary-button:hover {
      background-color: #f9fafb;
      border-color: #9ca3af;
    }

    .mode-toggle {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 100;
    }

    .admin-only {
      display: block;
    }

    .user-mode .admin-only {
      display: none;
    }

    /* Adicione estes estilos no final do seu CSS */
    #reserveModal.visible {
      display: flex;
      opacity: 1;
    }

    #reserveModal.visible>div {
      transform: scale(1);
    }

    /* Adicione esta nova classe ao seu CSS */
    .reserved-card {
      background-color: #f0fdf4;
      /* Verde claro, combinando com o fundo */
      border-color: #bbf7d0;
      /* Uma borda verde um pouco mais escura para destacar */
    }

    /* Adicione estas novas classes ao seu CSS */
    .card-number-badge {
      position: absolute;
      top: -10px;
      left: -10px;
      background-color: #4ade80;
      /* Um verde vibrante */
      color: white;
      width: 2rem;
      height: 2rem;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
      font-size: 0.9rem;
      border: 2px solid white;
    }

    .count-badge {
      display: inline-block;
      margin-left: 0.75rem;
      background-color: #e7e5e4;
      color: #57534e;
      padding: 0.1rem 0.6rem;
      border-radius: 9999px;
      font-size: 0.9rem;
      font-weight: 500;
    }
  </style>
</head>

<body class="gradient-bg min-h-full" id="mainBody">
  <div class="mode-toggle">
    <button onclick="toggleMode()" id="modeToggle"
      class="bg-white shadow-lg rounded-full px-4 py-2 text-sm font-medium border border-gray-200 hover:shadow-xl transition-all">
      ğŸ‘¤ Modo UsuÃ¡rio
    </button>
  </div>

  <main class="container mx-auto px-4 py-8 max-w-4xl">
    <header class="text-center mb-12">
      <h1 class="text-4xl font-bold text-green-800 mb-4">ğŸ  Lista de Presentes</h1>
      <h2 class="text-2xl text-green-600 mb-2">ChÃ¡ de Casa Nova</h2>
      <p class="text-gray-600 max-w-2xl mx-auto">Escolha um presente especial para nossa nova casa! Clique em "SugestÃ£o da Loja"
        para ser direcionado Ã  loja ou anote o nome do produto para comprar onde preferir.</p>

      <div id="modeIndicator"
        class="mt-4 inline-flex items-center px-4 py-2 bg-green-100 text-green-800 rounded-full text-sm font-medium">
        ğŸ”§ Modo Administrador - VocÃª pode editar a lista
      </div>
    </header>

    <div class="admin-only text-center mb-8">
      <button onclick="showAddForm()"
        class="gold-accent text-white px-6 py-3 rounded-full font-semibold shadow-lg hover:shadow-xl transition-all duration-300">
        âœ¨ Adicionar Presente
      </button>
    </div>

    <div id="addForm" class="admin-only hidden bg-white rounded-2xl shadow-lg p-6 mb-8 border border-green-100">
      <h3 class="text-xl font-semibold text-green-800 mb-4">Adicionar Novo Presente</h3>
      <form onsubmit="addItem(event)" class="space-y-4">
        <div>
          <label for="itemName" class="block text-sm font-medium text-gray-700 mb-1">Nome do Produto</label>
          <input type="text" id="itemName" required
            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent">
        </div>
        <div>
          <label for="itemLink" class="block text-sm font-medium text-gray-700 mb-1">Link de Compra</label>
          <input type="url" id="itemLink" required
            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent"
            placeholder="https://...">
        </div>
        <div>
          <label for="itemCategory" class="block text-sm font-medium text-gray-700 mb-1">Categoria</label>
          <select id="itemCategory"
            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent">
            <option value="Cozinha">ğŸ³ Cozinha</option>
            <option value="Sala">ğŸ›‹ Sala</option>
            <option value="Quarto">ğŸ› Quarto</option>
            <option value="Banheiro">ğŸš¿ Banheiro</option>
            <option value="DecoraÃ§Ã£o">ğŸ¨ DecoraÃ§Ã£o</option>
            <option value="Limpeza">ğŸ§½ Limpeza</option>
            <option value="Outros">ğŸ“¦ Outros</option>
          </select>
        </div>
        <div class="flex gap-3">
          <button type="submit"
            class="flex-1 bg-green-600 text-white py-2 px-4 rounded-lg hover:bg-green-700 transition-colors">
            Adicionar
          </button>
          <button type="button" onclick="hideAddForm()"
            class="flex-1 bg-gray-300 text-gray-700 py-2 px-4 rounded-lg hover:bg-gray-400 transition-colors">
            Cancelar
          </button>
        </div>
      </form>
    </div>

    <div id="giftListContainer" class="space-y-12">
      <div>
      <h2 id="available-title" class="text-2xl font-bold text-green-700 mb-6 pb-2 border-b-2 border-green-200">ğŸ DisponÃ­veis para reservar
</h2>
        <div id="availableGiftsList" class="grid gap-6 md:grid-cols-2 lg:grid-cols-3">
        </div>
      </div>

      <div id="reservedSection">
    <h2 id="reserved-title" class="text-2xl font-bold text-gray-600 mb-6 pb-2 border-b-2 border-gray-300">âœ… JÃ¡ Reservados</h2>
    <div id="reservedGiftsList" class="grid gap-6 md:grid-cols-2 lg:grid-cols-3">
    </div>
</div>
    </div>
    <div id="editModal"
      class="admin-only hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
      <div class="bg-white rounded-2xl shadow-xl p-6 w-full max-w-md">
        <h3 class="text-xl font-semibold text-green-800 mb-4">Editar Presente</h3>
        <form onsubmit="updateItem(event)" class="space-y-4">
          <input type="hidden" id="editItemId">
          <div>
            <label for="editItemName" class="block text-sm font-medium text-gray-700 mb-1">Nome do Produto</label>
            <input type="text" id="editItemName" required
              class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent">
          </div>
          <div>
            <label for="editItemLink" class="block text-sm font-medium text-gray-700 mb-1">Link de Compra</label>
            <input type="url" id="editItemLink" required
              class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent">
          </div>
          <div>
            <label for="editItemCategory" class="block text-sm font-medium text-gray-700 mb-1">Categoria</label>
            <select id="editItemCategory"
              class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent">
              <option value="Cozinha">ğŸ³ Cozinha</option>
              <option value="Sala">ğŸ›‹ Sala</option>
              <option value="Quarto">ğŸ› Quarto</option>
              <option value="Banheiro">ğŸš¿ Banheiro</option>
              <option value="DecoraÃ§Ã£o">ğŸ¨ DecoraÃ§Ã£o</option>
              <option value="Limpeza">ğŸ§½ Limpeza</option>
              <option value="Outros">ğŸ“¦ Outros</option>
            </select>
          </div>
          <div class="flex gap-3">
            <button type="submit"
              class="flex-1 bg-green-600 text-white py-2 px-4 rounded-lg hover:bg-green-700 transition-colors">
              Salvar
            </button>
            <button type="button" onclick="hideEditModal()"
              class="flex-1 bg-gray-300 text-gray-700 py-2 px-4 rounded-lg hover:bg-gray-400 transition-colors">
              Cancelar
            </button>
          </div>
        </form>
      </div>
    </div>
    <div id="reserveModal"
      class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4 transition-opacity duration-300">
      <div
        class="bg-white rounded-2xl shadow-xl p-8 w-full max-w-md transform transition-transform duration-300 scale-95">
        <h3 class="text-2xl font-bold text-green-800 mb-2">Confirmar Reserva</h3>
        <p class="text-gray-600 mb-6">Que Ã³timo que vocÃª escolheu este presente! Por favor, insira seu nome para que os
          outros convidados saibam.</p>
        <form id="reserveForm" class="space-y-4">
          <input type="hidden" id="reserveGiftId">
          <div>
            <label for="buyerName" class="block text-sm font-medium text-gray-700 mb-1">Seu nome</label>
            <input type="text" id="buyerName" required placeholder="Digite seu nome aqui..."
              class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent">
          </div>
          <div class="flex gap-3 pt-4">
            <button type="button" onclick="hideReserveModal()" class="secondary-button">
              Cancelar
            </button>
            <button type="submit" class="primary-button">
              âœ”ï¸ Confirmar
            </button>
          </div>
        </form>
      </div>
    </div>
  </main>

  <script type="module">
    // --- IMPORTAÃ‡Ã•ES E CONFIGURAÃ‡ÃƒO DO FIREBASE (permanecem iguais) ---
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-auth.js";
    import { getFirestore, collection, getDocs, addDoc, doc, updateDoc, deleteDoc, runTransaction } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDHzO4EEriWRsbIwW6Dry0pQAww4e4d3-c",
      authDomain: "lista-de-presentes-e3c02.firebaseapp.com",
      projectId: "lista-de-presentes-e3c02",
      storageBucket: "lista-de-presentes-e3c02.appspot.com",
      messagingSenderId: "89325375943",
      appId: "1:89325375943:web:4cca547dbfcdbc0f5909e2",
      measurementId: "G-N421XQHTF8"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const categoryEmojis = {
      Cozinha: "ğŸ³", Sala: "ğŸ›‹", Quarto: "ğŸ›", Banheiro: "ğŸš¿",
      DecoraÃ§Ã£o: "ğŸ¨", Limpeza: "ğŸ§½", Outros: "ğŸ“¦"
    };

    const ADMIN_EMAIL = "admin@gmail.com";
    let gifts = [];
    let isAdminMode = false;

    // --- ELEMENTOS DA PÃGINA ---
    const body = document.getElementById('mainBody');
    const modeIndicator = document.getElementById('modeIndicator');
    const reserveModal = document.getElementById('reserveModal');
    const reserveForm = document.getElementById('reserveForm');

    onAuthStateChanged(auth, user => {
      isAdminMode = user && user.email === ADMIN_EMAIL;
      body.classList.toggle('user-mode', !isAdminMode);
      const modeToggle = document.getElementById('modeToggle');
      if (isAdminMode) {
        modeIndicator.innerHTML = 'ğŸ”§ Modo Administrador';
        modeToggle.innerHTML = 'ğŸšª Sair';
        modeToggle.onclick = logout;
      } else {
        modeIndicator.innerHTML = 'ğŸ‘ Modo VisualizaÃ§Ã£o';
        modeToggle.innerHTML = 'ğŸ‘¤ Login Admin';
        modeToggle.onclick = () => { window.location.href = 'login.html'; };
      }
      fetchGifts();
    });

    // --- NOVAS FUNÃ‡Ã•ES PARA CONTROLAR O MODAL ---
    window.showReserveModal = function (giftId) {
      document.getElementById('reserveGiftId').value = giftId;
      reserveModal.classList.remove('hidden');
      setTimeout(() => reserveModal.classList.add('visible'), 10); // Para a animaÃ§Ã£o funcionar
    }

    window.hideReserveModal = function () {
      reserveModal.classList.remove('visible');
      setTimeout(() => reserveModal.classList.add('hidden'), 300); // Espera a animaÃ§Ã£o terminar
    }

    // FunÃ§Ã£o que Ã© chamada ao enviar o formulÃ¡rio do modal
    async function handleReservationSubmit(event) {
      event.preventDefault();
      const giftId = document.getElementById('reserveGiftId').value;
      const buyerName = document.getElementById('buyerName').value;

      if (!buyerName || buyerName.trim() === "") {
        alert("Por favor, preencha seu nome.");
        return;
      }

      const giftRef = doc(db, 'gifts', giftId);

      try {
        await runTransaction(db, async (transaction) => {
          const giftDoc = await transaction.get(giftRef);

          if (!giftDoc.exists()) {
            throw "Este presente nÃ£o existe mais na lista.";
          }

          const giftData = giftDoc.data();

          // A verificaÃ§Ã£o principal: o presente jÃ¡ foi comprado?
          if (giftData.purchased) {
            // Se sim, geramos um erro especÃ­fico que serÃ¡ capturado pelo bloco catch
            throw "Oops! Parece que outra pessoa acabou de reservar este presente. Por favor, escolha outro. ğŸ˜Š";
          }

          // Se nÃ£o, nÃ³s atualizamos o documento dentro da transaÃ§Ã£o
          transaction.update(giftRef, {
            purchased: true,
            purchasedBy: buyerName.trim()
          });
        });

        // Se a transaÃ§Ã£o for bem-sucedida
        hideReserveModal();
        fetchGifts();

      } catch (error) {
        // Aqui capturamos o erro, seja o nosso erro personalizado ou um erro do Firebase
        console.error("Erro na transaÃ§Ã£o de reserva: ", error);
        alert(error); // Mostra a mensagem de erro amigÃ¡vel para o usuÃ¡rio
        hideReserveModal();
        fetchGifts(); // Atualiza a lista para mostrar que o item foi reservado por outra pessoa
      }
    }
    reserveForm.addEventListener('submit', handleReservationSubmit);


    // --- FUNÃ‡Ã•ES DE DADOS (funÃ§Ã£o markAsPurchased foi removida e sua lÃ³gica movida para handleReservationSubmit) ---
  async function fetchGifts() {
      const availableGiftList = document.getElementById('availableGiftsList');
      if (availableGiftList) availableGiftList.innerHTML = '<p class="text-gray-500 col-span-3 text-center">Carregando presentes...</p>';
      try {
        const snapshot = await getDocs(collection(db, 'gifts'));
        gifts = snapshot.docs.map(d => ({ id: d.id, ...d.data() }));
        renderGifts();
      } catch (error) {
        console.error("Erro ao buscar presentes: ", error);
        if (availableGiftList) availableGiftList.innerHTML = '<p class="text-red-500 col-span-3 text-center">NÃ£o foi possÃ­vel carregar a lista.</p>';
      }
    }

    // --- *** FUNÃ‡ÃƒO RENDER GIFTS TOTALMENTE ATUALIZADA *** ---

    function renderGifts() {
        const availableList = document.getElementById('availableGiftsList');
        const reservedList = document.getElementById('reservedGiftsList');
        const availableTitle = document.getElementById('available-title');
        const reservedTitle = document.getElementById('reserved-title');
        const reservedSection = document.getElementById('reservedSection');

        // Limpa as listas antes de adicionar os itens atualizados
        availableList.innerHTML = '';
        reservedList.innerHTML = '';

        // Filtra os presentes entre disponÃ­veis e reservados
        const availableGifts = gifts.filter(gift => !gift.purchased).sort((a, b) => a.name.localeCompare(b.name));
        const reservedGifts = gifts.filter(gift => gift.purchased).sort((a, b) => a.name.localeCompare(b.name));

        // ATUALIZA OS TÃTULOS COM A CONTAGEM
        availableTitle.innerHTML = `ğŸ DisponÃ­veis para reservar <span class="count-badge">${availableGifts.length}</span>`;
        reservedTitle.innerHTML = `âœ… JÃ¡ Reservados <span class="count-badge">${reservedGifts.length}</span>`;

        // 1. Renderiza a lista de PRESENTES DISPONÃVEIS
        if (availableGifts.length === 0 && reservedGifts.length > 0) {
            availableList.innerHTML = '<p class="text-gray-500 col-span-3 text-center">Ã“tima notÃ­cia! Todos os presentes jÃ¡ foram escolhidos. âœ¨</p>';
        } else if (gifts.length === 0) {
            availableList.innerHTML = isAdminMode ? '<p class="text-gray-500 col-span-3 text-center">Nenhum presente na lista. Clique em "Adicionar Presente" para comeÃ§ar!</p>' : '<p class="text-gray-500 col-span-3 text-center">A lista de presentes estÃ¡ sendo preparada. Volte em breve!</p>';
        } else {
            availableGifts.forEach((gift, index) => {
                const giftCard = document.createElement('div');
                giftCard.className = 'item-card';

                const adminControlsHTML = isAdminMode ? `
                    <div class="admin-controls">
                        <button onclick="editItem('${gift.id}')" class="admin-btn text-gray-500 hover:text-blue-600" title="Editar"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M15.502 1.94a.5.5 0 0 1 0 .706L14.459 3.69l-2-2L13.502.646a.5.5 0 0 1 .707 0l1.293 1.293zm-1.75 2.456-2-2L4.939 9.21a.5.5 0 0 0-.121.196l-.805 2.414a.25.25 0 0 0 .316.316l2.414-.805a.5.5 0 0 0 .196-.12l6.813-6.814z"/><path fill-rule="evenodd" d="M1 13.5A1.5 1.5 0 0 0 2.5 15h11a1.5 1.5 0 0 0 1.5-1.5v-6a.5.5 0 0 0-1 0v6a.5.5 0 0 1-.5.5h-11a.5.5 0 0 1-.5-.5v-11a.5.5 0 0 1 .5-.5H9a.5.5 0 0 0 0-1H2.5A1.5 1.5 0 0 0 1 2.5v11z"/></svg></button>
                        <button onclick="deleteItem('${gift.id}')" class="admin-btn text-gray-500 hover:text-red-600" title="Excluir"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0V6z"/><path fill-rule="evenodd" d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1v1zM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4H4.118zM2.5 3V2h11v1h-11z"/></svg></button>
                    </div>` : '';

                giftCard.innerHTML = `
                    <div class="card-number-badge">${index + 1}</div>
                    ${adminControlsHTML}
                    <div class="flex-grow">
                        <span class="category-tag">${categoryEmojis[gift.category] || 'ğŸ'} ${gift.category}</span>
                        <h3 class="text-lg font-semibold text-gray-800 mt-3 mb-4">${gift.name}</h3>
                    </div>
                    <div class="mt-auto flex flex-col sm:flex-row gap-3">
                        <button onclick="openStoreLink('${gift.link}')" class="secondary-button w-full sm:w-auto flex-1">SugestÃ£o de Loja</button>
                        <button onclick="showReserveModal('${gift.id}')" class="primary-button w-full sm:w-auto flex-1">ğŸ Reservar</button>
                    </div>
                `;
                availableList.appendChild(giftCard);
            });
        }

        // 2. Renderiza a lista de PRESENTES RESERVADOS
        if (reservedGifts.length > 0) {
            reservedSection.classList.remove('hidden');
            reservedGifts.forEach((gift, index) => {
                const giftCard = document.createElement('div');
                giftCard.className = 'item-card reserved-card';

                const adminControlsHTML = isAdminMode ? `
                    <div class="admin-controls">
                        <button onclick="editItem('${gift.id}')" class="admin-btn text-gray-500 hover:text-blue-600" title="Editar"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M15.502 1.94a.5.5 0 0 1 0 .706L14.459 3.69l-2-2L13.502.646a.5.5 0 0 1 .707 0l1.293 1.293zm-1.75 2.456-2-2L4.939 9.21a.5.5 0 0 0-.121.196l-.805 2.414a.25.25 0 0 0 .316.316l2.414-.805a.5.5 0 0 0 .196-.12l6.813-6.814z"/><path fill-rule="evenodd" d="M1 13.5A1.5 1.5 0 0 0 2.5 15h11a1.5 1.5 0 0 0 1.5-1.5v-6a.5.5 0 0 0-1 0v6a.5.5 0 0 1-.5.5h-11a.5.5 0 0 1-.5-.5v-11a.5.5 0 0 1 .5-.5H9a.5.5 0 0 0 0-1H2.5A1.5 1.5 0 0 0 1 2.5v11z"/></svg></button>
                        <button onclick="deleteItem('${gift.id}')" class="admin-btn text-gray-500 hover:text-red-600" title="Excluir"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0V6z"/><path fill-rule="evenodd" d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1v1zM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4H4.118zM2.5 3V2h11v1h-11z"/></svg></button>
                    </div>` : '';

                giftCard.innerHTML = `
                    <div class="card-number-badge" style="background-color: #6b7280;">${index + 1}</div>
                    ${adminControlsHTML}
                    <div class="flex-grow">
                        <span class="category-tag">${categoryEmojis[gift.category] || 'ğŸ'} ${gift.category}</span>
                        <h3 class="text-lg font-semibold text-gray-500 mt-3" style="text-decoration: line-through;">${gift.name}</h3>
                    </div>
                    <div class="mt-4 pt-4 border-t border-gray-200">
                        <p class="text-center text-sm text-gray-700">ğŸ Reservado por <strong>${gift.purchasedBy}</strong></p>
                        ${isAdminMode ? `<button onclick="togglePurchasedStatus('${gift.id}', ${gift.purchased})" class="text-sm text-blue-500 hover:underline mt-3 w-full text-center">Reverter Status</button>` : ''}
                    </div>
                `;
                reservedList.appendChild(giftCard);
            });
        } else {
            // Se nÃ£o houver itens reservados, oculta a seÃ§Ã£o inteira
            reservedSection.classList.add('hidden');
        }
    }



    // --- FUNÃ‡Ã•ES AUXILIARES (todo o resto permanece igual) ---
    window.logout = function () { signOut(auth); };
    window.showAddForm = function () { if (isAdminMode) document.getElementById('addForm').classList.remove('hidden'); };
    // ... e todas as outras funÃ§Ãµes que vocÃª jÃ¡ tem (deleteItem, updateItem, etc.) ...
    // --- FUNÃ‡Ã•ES AUXILIARES (permanecem as mesmas) ---
    window.addItem = async function (event) {
      event.preventDefault();
      if (!isAdminMode) return;
      const name = document.getElementById('itemName').value;
      const link = document.getElementById('itemLink').value;
      const category = document.getElementById('itemCategory').value;
      try {
        await addDoc(collection(db, 'gifts'), { name, link, category, purchased: false, purchasedBy: "" });
        hideAddForm();
        fetchGifts();
      } catch (error) { console.error("Erro ao adicionar item: ", error); }
    }
    window.togglePurchasedStatus = async function (id, currentStatus) {
      if (!isAdminMode) return;
      const newStatus = !currentStatus;
      try {
        await updateDoc(doc(db, 'gifts', id), { purchased: newStatus, purchasedBy: newStatus ? "Admin" : "" });
        fetchGifts();
      } catch (error) { console.error("Erro ao alterar status: ", error); }
    }
    window.hideAddForm = function () { document.getElementById('addForm').classList.add('hidden'); document.getElementById('addForm').querySelector('form').reset(); }
    window.hideEditModal = function () { document.getElementById('editModal').classList.add('hidden'); }
    window.updateItem = async function (event) {
      event.preventDefault();
      if (!isAdminMode) return;
      const id = document.getElementById('editItemId').value;
      const name = document.getElementById('editItemName').value;
      const link = document.getElementById('editItemLink').value;
      const category = document.getElementById('editItemCategory').value;
      try {
        await updateDoc(doc(db, 'gifts', id), { name, link, category });
        hideEditModal();
        fetchGifts();
      } catch (error) { console.error("Erro ao atualizar item: ", error); }
    }
    window.deleteItem = async function (id) {
      if (!isAdminMode) return;
      if (confirm("Tem certeza que deseja excluir este presente?")) {
        try {
          await deleteDoc(doc(db, 'gifts', id));
          fetchGifts();
        } catch (error) { console.error("Erro ao deletar item: ", error); }
      }
    }
    window.editItem = function (id) {
      if (!isAdminMode) return;
      const gift = gifts.find(g => g.id === id);
      if (gift) {
        document.getElementById('editItemId').value = id;
        document.getElementById('editItemName').value = gift.name;
        document.getElementById('editItemLink').value = gift.link;
        document.getElementById('editItemCategory').value = gift.category;
        document.getElementById('editModal').classList.remove('hidden');
      }
    }
    window.openStoreLink = function (link) {
      window.open(link, '_blank', 'noopener,noreferrer');
    }
  </script>
</body>

</html>
